<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=1024" />
  <title>ê³µì§€ì‚¬í•­ - ì›ì£¼ì—¬ìê³ ë“±í•™êµ</title>
  <style>
    body{margin:0;font-family:'Noto Sans KR',sans-serif;background:#fff0f3;}
    .header{display:flex;justify-content:space-between;align-items:center;padding:10px 20px;border-bottom:2px solid #000;}
    .nav-container{flex:1;display:flex;justify-content:center;}
    .nav{display:flex;gap:80px;font-size:14px;}
    .nav a{text-decoration:none;color:#000;}
    .nav a:hover{font-weight:bold;}
    .login{background:#fce4ec;padding:5px 15px;border-radius:10px;font-size:14px;cursor:pointer;}

    /* í†µì¼ëœ nav-bar */
    .nav-bar {
      background-color: #ffcbd6; display: flex; justify-content: space-around; align-items: center;
      height: 48px; font-size: 14px; margin: 20px; border-radius: 10px;
      border: 2px solid #f9aebe; box-shadow: 0 2px 5px rgba(0, 0, 0, 0.05); overflow: hidden;
    }
    .nav-bar a {
      flex: 1; text-align: center; text-decoration: none; color: black; padding: 10px 0;
      border-right: 1px solid #d999aa; transition: all 0.2s ease;
    }
    .nav-bar a:last-child { border-right: none; }
    .nav-bar a:hover { background-color: #fdd8e1; font-weight: bold; }

    .main{padding:30px;}

    /* posts.htmlê³¼ í†µì¼ëœ square */
    .square {
      background: #FFDDE3; padding: 30px; border-radius: 10px;
      box-shadow: 0 2px 5px rgba(0,0,0,.05); border: 2px solid #f9aebe; margin-top: 20px;
    }
    h2 { margin-top: 0; color: #5b3b3b; font-size: 22px; }

    /* ì¹´ë“œ ë¦¬ìŠ¤íŠ¸ (postsì™€ í†µì¼) */
    .post-list { display: flex; flex-direction: column; gap: 15px; height: 500px; overflow-y: auto; }
    .post {
      background:#fff; padding:15px; border-radius:10px; box-shadow:0 2px 5px rgba(0,0,0,.05);
      border:1px solid #f9aebe; transition:.2s; display:flex; justify-content:space-between; align-items:center; gap:10px;
    }
    .post:hover{ background:#fff3f5; transform: translateY(-1px); }
    .post a{ text-decoration:none; color:inherit; display:flex; justify-content:space-between; align-items:center; width:100%; gap:10px; }
    .post-title{ font-weight:bold; font-size:16px; }
    .post-info{ font-size:12px; color:gray; text-align:right; white-space:nowrap; }

    /* ê´€ë¦¬ì ì „ìš© ì•„ì´ì½˜ */
    .delete-btn{
      cursor:pointer; user-select:none; font-size:18px; line-height:1;
      padding:4px 6px; border-radius:6px;
    }
    .delete-btn:hover{ background:#ffe3ea; }
    .write-btn{
      background:#f9aebe;color:#fff;border-radius:10px;padding:6px 12px;
      text-decoration:none;border:1px solid #f4a2b5;
    }
    .wjg{ text-decoration:none;color:#000;padding:10px 20px; }
  </style>
</head>
<body style="overflow:none">
  <div class="header">
    <a href="index.html" class="wjg"><b>ì›ì£¼ì—¬ìê³ ë“±í•™êµ</b></a>
    <div class="nav-container">
      <div class="nav">
        <a href="posts.html">ê²Œì‹œíŒ</a>
        <a href="notice.html" class="active">ê³µì§€ì‚¬í•­</a>
        <a href="inquiry.html">ë¬¸ì˜í•˜ê¸°</a>
      </div>
    </div>
    <div class="login">ë¡œê·¸ì¸</div>
  </div>

  <div class="nav-bar" id="navBar">
    <a href="notice.html" class="active">ê³µì§€ ëª©ë¡</a>
    <!-- ê´€ë¦¬ìë©´ 'ê³µì§€ ì‘ì„±' ë²„íŠ¼ì´ ë™ì ìœ¼ë¡œ ë¶™ìŠµë‹ˆë‹¤ -->
  </div>

  <div class="main">
    <div class="square">
      <h2 style="margin:0 0 12px 0;">ê³µì§€ ëª©ë¡</h2>
      <div class="post-list" id="noticeList"></div>
    </div>
  </div>

  <script type="module">
    import { initializeApp, getApps } from "https://www.gstatic.com/firebasejs/11.9.1/firebase-app.js";
    import { getAuth, signInAnonymously } from "https://www.gstatic.com/firebasejs/11.9.1/firebase-auth.js";
    import { getFirestore, collection, query, orderBy, getDocs, getDoc, doc, deleteDoc, limit } from "https://www.gstatic.com/firebasejs/11.9.1/firebase-firestore.js";

    const firebaseConfig = {
      apiKey: "AIzaSyCrxJuOjHGdttC2gfwfjqsvAjHicEav6BA",
      authDomain: "wjgh-learningdataroom.firebaseapp.com",
      projectId: "wjgh-learningdataroom",
      storageBucket: "wjgh-learningdataroom.firebasestorage.app",
      messagingSenderId: "284248567704",
      appId: "1:284248567704:web:88e70e08666e13ff80c5ed"
    };

    const app = getApps().length ? getApps()[0] : initializeApp(firebaseConfig);
    const auth = getAuth(app);
    signInAnonymously(auth).catch(console.warn);
    const db = getFirestore(app);

    const API_BASE = "http://127.0.0.1:5000";

    // ë¡œê·¸ì¸/ë²„íŠ¼ UI
    let currentUser = null;
    document.addEventListener("DOMContentLoaded", () => {
      const userStr = localStorage.getItem("user");
      const loginDiv = document.querySelector(".login");
      const navBar = document.getElementById("navBar");

      if (userStr) {
        currentUser = JSON.parse(userStr);
        loginDiv.textContent = `${currentUser.name}ë‹˜ í™˜ì˜í•©ë‹ˆë‹¤`;
        loginDiv.style.fontWeight = "bold";
        loginDiv.style.cursor = "default";
        loginDiv.addEventListener("click", () => {
          if (confirm("ë¡œê·¸ì•„ì›ƒ í•˜ì‹œê² ìŠµë‹ˆê¹Œ?")) {
            localStorage.removeItem("user"); location.reload();
          }
        });

        // ê´€ë¦¬ì ì „ìš© 'ê³µì§€ ì‘ì„±' ë²„íŠ¼ ì¶”ê°€
        if (currentUser.role === "admin") {
          const a = document.createElement("a");
          a.href = "write-notice.html";
          a.className = "write-btn";
          a.textContent = "ê³µì§€ ì‘ì„±";
          navBar.appendChild(a);
        }
      } else {
        loginDiv.textContent = "ë¡œê·¸ì¸";
        loginDiv.style.cursor = "pointer";
        loginDiv.addEventListener("click", () => location.href = "login.html");
      }
    });

    // ê³µì§€ ëª©ë¡ ë¡œë“œ
    async function loadNotices() {
      const list = document.getElementById("noticeList");
      list.innerHTML = "ë¡œë”©ì¤‘â€¦";

      let docsArr = [];
      try {
        const q = query(collection(db, "notices"), orderBy("createdAt", "desc"), limit(300));
        const snap = await getDocs(q);
        snap.forEach(d => docsArr.push({ id: d.id, data: d.data() }));
      } catch (e) {
        console.warn("createdAt ì •ë ¬ ì‹¤íŒ¨, ì „ì²´ ìŠ¤ìº”:", e);
        const snap = await getDocs(collection(db, "notices"));
        snap.forEach(d => docsArr.push({ id: d.id, data: d.data() }));
        docsArr.sort((a,b)=>{
          const ta = a.data.createdAt?.seconds ?? a.data.createdAt?._seconds ?? 0;
          const tb = b.data.createdAt?.seconds ?? b.data.createdAt?._seconds ?? 0;
          return tb - ta;
        });
      }

      list.innerHTML = "";
      if (!docsArr.length) {
        list.innerHTML = "<div style='color:#777'>ë“±ë¡ëœ ê³µì§€ê°€ ì—†ìŠµë‹ˆë‹¤.</div>";
        return;
      }

      for (const { id, data } of docsArr) {
        const title = data.title || "ì œëª© ì—†ìŒ";
        const dateStr = data.createdAt?.toDate
          ? data.createdAt.toDate().toLocaleDateString("ko-KR")
          : "";
        const row = document.createElement("div");
        row.className = "post";
        row.innerHTML = `
          <a href="view-notice.html?id=${id}">
            <div>
              <div class="post-title">${title}</div>
              <div class="post-info">${data.nickname || "ê´€ë¦¬ì"}</div>
            </div>
            <div class="post-info">${dateStr}</div>
          </a>
          ${currentUser?.role === "admin" ? `<span class="delete-btn" title="ì‚­ì œ" data-id="${id}">ğŸ—‘</span>` : ""}
        `;
        list.appendChild(row);
      }
    }

    // (ê´€ë¦¬ì) ì‚­ì œ í•¸ë“¤ëŸ¬: ì²¨ë¶€ê¹Œì§€ í•¨ê»˜ ì‚­ì œ
    document.addEventListener("click", async (e) => {
      const btn = e.target.closest(".delete-btn");
      if (!btn) return;

      if (currentUser?.role !== "admin") {
        alert("ê´€ë¦¬ìë§Œ ì‚­ì œí•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.");
        return;
      }

      const id = btn.getAttribute("data-id");
      if (!id) return;

      if (!confirm("ì •ë§ ì´ ê³µì§€ë¥¼ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ? ì²¨ë¶€íŒŒì¼ì´ ìˆë‹¤ë©´ í•¨ê»˜ ì‚­ì œë©ë‹ˆë‹¤.")) return;

      try {
        // ì²¨ë¶€ í™•ì¸
        const snap = await getDoc(doc(db, "notices", id));
        const data = snap.exists() ? snap.data() : null;

        if (data?.attachment?.key) {
          try {
            await fetch(`${API_BASE}/api/delete?key=${encodeURIComponent(data.attachment.key)}`, { method: "DELETE" });
          } catch (err) {
            console.warn("ì²¨ë¶€ ì‚­ì œ ì‹¤íŒ¨(ë¬´ì‹œ ê°€ëŠ¥):", err);
          }
        }

        await deleteDoc(doc(db, "notices", id));
        alert("ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.");
        location.reload();
      } catch (err) {
        console.error(err);
        alert("ì‚­ì œ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.");
      }
    });

    loadNotices();
  </script>
</body>
</html>
