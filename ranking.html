<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=1024" />
  <title>ì „ì²´ ë­í‚¹ - ì›ì£¼ì—¬ìê³ ë“±í•™êµ</title>
  <style>
    body{margin:0;font-family:'Noto Sans KR',sans-serif;background:#fff0f3;}
    .header{display:flex;justify-content:space-between;align-items:center;padding:10px 20px;border-bottom:2px solid #000;}
    .nav-container{flex:1;display:flex;justify-content:center;}
    .nav{display:flex;gap:80px;font-size:14px;}
    .nav a{text-decoration:none;color:#000;}
    .nav a:hover{font-weight:bold;}
    .login{background:#fce4ec;padding:5px 15px;border-radius:10px;font-size:14px;cursor:pointer;}

    .main{padding:30px;}
    .square{
      background:#FFDDE3;
      padding:30px;
      border-radius:10px;
      box-shadow:0 2px 5px rgba(0,0,0,.05);
      border:2px solid #f9aebe;
      margin-top:20px;
      max-width:900px;
      margin-left:auto; margin-right:auto;
    }

    .toolbar{
      display:flex; gap:10px; align-items:center; flex-wrap:wrap; margin-bottom:16px;
    }
    .toolbar .title{font-size:22px;font-weight:700;color:#5b3b3b;margin-right:auto;}
    .pill{background:#ffd2db;border:1px solid #f9aebe;border-radius:999px;padding:6px 12px;font-size:13px;}
    .select, .search{
      background:#fff;border:1px solid #f9aebe;border-radius:8px;padding:8px 10px;font-size:14px;
    }
    .search{min-width:240px;}

    .ranking-list{display:flex;flex-direction:column;gap:10px;max-height:560px;overflow:auto;}
    .rank-item{
      display:flex;align-items:center;justify-content:space-between;
      background:#fff;border:1px solid #f9aebe;border-radius:10px;padding:12px 14px;
      box-shadow:0 2px 5px rgba(0,0,0,.05);
    }
    .rank-left{display:flex;align-items:center;gap:10px;}
    .rank-medal{
      width:32px;height:32px;display:flex;align-items:center;justify-content:center;
      border-radius:50%;background:#ffe6ec;border:1px solid #f9aebe;font-weight:700;
    }
    .rank-name{font-weight:600;color:#333;}
    .rank-meta{font-size:12px;color:#888;}
    .rank-score-badge{font-size:13px;color:#5b3b3b;background:#fff8fb;border:1px solid #f9aebe;padding:4px 8px;border-radius:8px;}

    .me-badge{margin-left:6px;font-size:11px;background:#fff3f7;border:1px solid #f9aebe;border-radius:6px;padding:2px 6px;color:#c4557a;}
    .hot{margin-left:6px;font-size:11px;background:#ffeab9;border:1px solid #f3c35f;border-radius:6px;padding:2px 6px;color:#825a00;}

    .more{display:block;margin:16px auto 0;background:#ffd2db;border:1px solid #f9aebe;border-radius:10px;padding:8px 14px;cursor:pointer;}
    .more:hover{background:#fff3f5;}
  </style>
</head>
<body>
  <div class="header">
    <a href="index.html" style="text-decoration:none;color:#000;padding:10px 20px;"><b>ì›ì£¼ì—¬ìê³ ë“±í•™êµ</b></a>
    <div class="nav-container">
      <div class="nav">
        <a href="posts.html">ê²Œì‹œíŒ</a>
        <a href="notice.html">ê³µì§€ì‚¬í•­</a>
        <a href="inquiry.html">ë¬¸ì˜í•˜ê¸°</a>
      </div>
    </div>
    <div class="login">ë¡œê·¸ì¸</div>
  </div>

  <div class="main">
    <div class="square">
      <div class="toolbar">
        <div class="title">ì „ì²´ ë­í‚¹</div>
        <!-- ë³´ê¸° ëª¨ë“œ(ì „ì²´/ì´ë²ˆ ë‹¬) â€” â€œì´ë²ˆ ë‹¬ ì ìˆ˜â€ í•„ë“œê°€ ì—†ìœ¼ë©´ ìë™ìœ¼ë¡œ ì „ì²´ë§Œ -->
        <select id="mode" class="select">
          <option value="all" selected>ì „ì²´ ì ìˆ˜</option>
          <option value="month">ì´ë²ˆ ë‹¬ ì ìˆ˜</option>
        </select>
        <!-- í•™ë…„ í•„í„° -->
        <select id="grade" class="select">
          <option value="ALL" selected>ì „ì²´ í•™ë…„</option>
          <option value="1í•™ë…„">1í•™ë…„</option>
          <option value="2í•™ë…„">2í•™ë…„</option>
          <option value="3í•™ë…„">3í•™ë…„</option>
        </select>
        <!-- ê²€ìƒ‰ -->
        <input id="q" class="search" type="text" placeholder="ë‹‰ë„¤ì„/ì´ë¦„ ê²€ìƒ‰" />
      </div>

      <div id="list" class="ranking-list"></div>
      <button id="btnMore" class="more" style="display:none;">ë” ë³´ê¸°</button>
    </div>
  </div>

  <script type="module">
    import { initializeApp, getApps } from "https://www.gstatic.com/firebasejs/11.9.1/firebase-app.js";
    import { getAuth, signInAnonymously } from "https://www.gstatic.com/firebasejs/11.9.1/firebase-auth.js";
    import {
      getFirestore, collection, query, orderBy, limit, getDocs
    } from "https://www.gstatic.com/firebasejs/11.9.1/firebase-firestore.js";

    // === Firebase ê¸°ë³¸ ì„¤ì • (ë„¤ í”„ë¡œì íŠ¸ ê°’) ===
    const firebaseConfig = {
      apiKey: "AIzaSyCrxJuOjHGdttC2gfwfjqsvAjHicEav6BA",
      authDomain: "wjgh-learningdataroom.firebaseapp.com",
      projectId: "wjgh-learningdataroom",
      storageBucket: "wjgh-learningdataroom.firebasestorage.app",
      messagingSenderId: "284248567704",
      appId: "1:284248567704:web:88e70e08666e13ff80c5ed"
    };
    const app = getApps().length ? getApps()[0] : initializeApp(firebaseConfig);
    const auth = getAuth(app);
    signInAnonymously(auth).catch(()=>{});
    const db = getFirestore(app);

    // ë¡œê·¸ì¸ ë°°ì§€/ë²„íŠ¼
    document.addEventListener("DOMContentLoaded", () => {
      const userStr = localStorage.getItem("user");
      const loginDiv = document.querySelector(".login");
      if (userStr) {
        const u = JSON.parse(userStr);
        loginDiv.textContent = `${u.name}ë‹˜ í™˜ì˜í•©ë‹ˆë‹¤`;
        loginDiv.style.fontWeight = "bold";
        loginDiv.style.cursor = "default";
        loginDiv.addEventListener("click", () => {
          if (confirm("ë¡œê·¸ì•„ì›ƒ í•˜ì‹œê² ìŠµë‹ˆê¹Œ?")) { localStorage.removeItem("user"); location.reload(); }
        });
      } else {
        loginDiv.textContent = "ë¡œê·¸ì¸";
        loginDiv.style.cursor = "pointer";
        loginDiv.addEventListener("click", () => location.href = "login.html");
      }
    });

    // ===== ë­í‚¹ ë¡œì§ =====
    const listEl = document.getElementById("list");
    const btnMore = document.getElementById("btnMore");
    const inputQ = document.getElementById("q");
    const selGrade = document.getElementById("grade");
    const selMode  = document.getElementById("mode");

    // ì ìˆ˜ â†’ ì´ëª¨ì§€
    function scoreEmoji(score){
      if (score >= 20) return "ğŸ”¥";
      if (score >= 10) return "ğŸŒŸ";
      if (score >= 5)  return "ğŸ‘";
      return "";
    }
    // TOP3 ë©”ë‹¬
    function rankMedal(n){
      if (n===1) return "ğŸ¥‡";
      if (n===2) return "ğŸ¥ˆ";
      if (n===3) return "ğŸ¥‰";
      return n;
    }

    let full = [];   // ì „ì²´ ì‚¬ìš©ì(ì •ë ¬ ì „)
    let view = [];   // í•„í„°+ì •ë ¬ í›„
    let shown = 0;   // ë Œë”ë§ëœ ê°œìˆ˜
    const PAGE = 30; // í•œ ë²ˆì— ë Œë”ë§í•  ê°œìˆ˜

    // ì•ˆì „í•˜ê²Œ ì ìˆ˜ ì½ê¸°: mode=allì€ user.score, mode=monthëŠ” user.monthScore(ì—†ìœ¼ë©´ 0)
    function pickScore(u){
      if (selMode.value === "month"){
        // ì›”ë³„ ì ìˆ˜ë¥¼ user.monthScore / user.scores['YYYY-MM'] ê°™ì€ ê³³ì— ì €ì¥í–ˆë‹¤ë©´ ì—¬ê¸°ì„œ êº¼ë‚´ì„œ ì‚¬ìš©
        // í˜„ì¬ëŠ” í˜¸í™˜ìš©: u.monthScore ìš°ì„ , ì—†ìœ¼ë©´ 0
        return Number(u.monthScore ?? 0);
      }
      return Number(u.score ?? 0);
    }

    function normalizeUser(d){
      const data = d.data();
      return {
        id: d.id,
        name: data.name || "",
        nickname: data.nickname || "",
        grade: data.grade || "",
        score: Number(data.score ?? 0),
        monthScore: Number(data.monthScore ?? 0),
        isHot: Boolean(data.isHotMember || data.hot || false) // ì—´í˜ˆë©¤ë²„ í•„ë“œ í˜¸í™˜
      };
    }

    async function fetchUsers(){
      full = [];
      // 1) ê¸°ë³¸: score ë‚´ë¦¼ì°¨ìˆœ ìƒìœ„ 300ëª… ì‹œë„
      try{
        const qy = query(collection(db, "users"), orderBy("score","desc"), limit(300));
        const snap = await getDocs(qy);
        snap.forEach(d => full.push(normalizeUser(d)));
      }catch(e){
        // ì¸ë±ìŠ¤/ê¶Œí•œ ë¬¸ì œë©´ ì „ì²´ ê°€ì ¸ì™€ì„œ í´ë¼ì´ì–¸íŠ¸ ì •ë ¬
        const snap = await getDocs(collection(db, "users"));
        snap.forEach(d => full.push(normalizeUser(d)));
      }
      applyAndRender(true);
    }

    function applyFilters(){
      const keyword = (inputQ.value || "").toLowerCase().trim();
      const g = selGrade.value;

      // í•„í„°
      view = full.filter(u => {
        if (g !== "ALL" && u.grade !== g) return false;
        if (keyword){
          const hay = `${u.nickname} ${u.name}`.toLowerCase();
          if (!hay.includes(keyword)) return false;
        }
        return true;
      });

      // ì •ë ¬ (ì„ íƒ ëª¨ë“œ ê¸°ì¤€ ì ìˆ˜)
      view.sort((a,b) => pickScore(b) - pickScore(a));
    }

    function render(reset=false){
      if (reset){
        listEl.innerHTML = "";
        shown = 0;
      }
      const end = Math.min(shown + PAGE, view.length);
      for (let i = shown; i < end; i++){
        const u = view[i];
        const rank = i + 1;
        const medal = rankMedal(rank);
        const score = pickScore(u);
        const badge = scoreEmoji(score);
        const name = (u.nickname || u.name || "ì´ë¦„ì—†ìŒ");
        const me = JSON.parse(localStorage.getItem("user") || "null");
        const isMe = me && (me.nickname === u.nickname || me.name === u.name || me.id === u.id);

        const row = document.createElement("div");
        row.className = "rank-item";
        row.innerHTML = `
          <div class="rank-left">
            <div class="rank-medal">${medal}</div>
            <div>
              <div class="rank-name">
                ${name} ${badge} ${u.isHot ? '<span class="hot">ì—´í˜ˆ</span>': ''} ${isMe ? '<span class="me-badge">ë‚´ ì ìˆ˜</span>' : ''}
              </div>
              <div class="rank-meta">${u.grade || ""}</div>
            </div>
          </div>
          <div class="rank-score-badge">${score} ì </div>
        `;
        listEl.appendChild(row);
      }
      shown = end;
      btnMore.style.display = (shown < view.length) ? "block" : "none";
      if (view.length === 0){
        listEl.innerHTML = "<div style='color:#777'>ë­í‚¹ ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.</div>";
        btnMore.style.display = "none";
      }
    }

    function applyAndRender(reset=false){
      applyFilters();
      render(reset);
    }

    // ì´ë²¤íŠ¸
    inputQ.addEventListener("input", () => applyAndRender(true));
    selGrade.addEventListener("change", () => applyAndRender(true));
    selMode.addEventListener("change",  () => applyAndRender(true));
    btnMore.addEventListener("click", () => render(false));

    fetchUsers();
  </script>
</body>
</html>
