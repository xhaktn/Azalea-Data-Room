<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=1024" />
<title>ë‚´ ê²Œì‹œê¸€ - ì›ì£¼ì—¬ìê³ ë“±í•™êµ</title>
<style>
  body{margin:0;font-family:'Noto Sans KR',sans-serif;background:#fff0f3;}
  .header{display:flex;justify-content:space-between;align-items:center;padding:10px 20px;border-bottom:2px solid #000;}
  .nav-container{flex:1;display:flex;justify-content:center;}
  .nav{display:flex;gap:80px;font-size:14px;}
  .nav a{text-decoration:none;color:#000;}
  .nav a:hover{font-weight:bold;}
  .login{background:#fce4ec;padding:5px 15px;border-radius:10px;font-size:14px;cursor:pointer;}

  .nav-bar {
    background:#ffcbd6; display:flex; justify-content:space-around; align-items:center;
    height:48px; font-size:14px; margin:20px; border-radius:10px;
    border:2px solid #f9aebe; box-shadow:0 2px 5px rgba(0,0,0,.05); overflow:hidden;
  }
  .nav-bar a {
    flex:1; text-align:center; text-decoration:none; color:#000; padding:10px 0;
    border-right:1px solid #d999aa; transition:all .2s ease;
  }
  .nav-bar a:last-child{border-right:none;}
  .nav-bar a:hover{background:#fdd8e1;font-weight:bold;}
  .nav-bar a.active{font-weight:bold;background:#f9aebe;color:#fff;}

  .main{padding:30px;}
  .square{
    background:#FFDDE3; padding:30px; border-radius:10px;
    border:2px solid #f9aebe; box-shadow:0 2px 5px rgba(0,0,0,.05); margin-top:20px;
  }
  h2{margin-top:0;color:#5b3b3b;font-size:22px;}

  /* ì¹´ë“œ ë¦¬ìŠ¤íŠ¸(í†µì¼) */
  .post-list{display:flex;flex-direction:column;gap:15px;height:500px;overflow-y:auto;}
  .item{background:#fff;border:1px solid #f9aebe;padding:14px 12px;border-radius:10px;display:flex;justify-content:space-between;align-items:center;gap:8px;box-shadow:0 2px 5px rgba(0,0,0,.05);}
  .title{font-size:16px;margin:0;color:#333}
  .meta{font-size:12px;color:#888}
  .actions{display:flex;gap:8px}
  .btn{padding:6px 10px;border-radius:6px;text-decoration:none;font-size:13px;border:1px solid transparent;cursor:pointer}
  .btn-view{background:#ffd2db;color:#000;border-color:#f9aebe}
  .btn-del{background:#ffb1b1;color:#fff;border-color:#e46f87}
</style>
</head>
<body style="overflow:none">
  <div class="header">
    <a href="index.html" style="text-decoration:none;color:#000;padding:10px 20px;"><b>ì›ì£¼ì—¬ìê³ ë“±í•™êµ</b></a>
    <div class="nav-container">
      <div class="nav">
        <a href="posts.html">ê²Œì‹œíŒ</a>
        <a href="notice.html">ê³µì§€ì‚¬í•­</a>
        <a href="inquiry.html">ë¬¸ì˜í•˜ê¸°</a>
      </div>
    </div>
    <div class="login">ë¡œê·¸ì¸</div>
  </div>

  <div class="nav-bar">
    <a href="posts.html">ê²Œì‹œê¸€ ë³´ê¸°</a>
    <a href="my-posts.html" class="active">ë‚´ ê²Œì‹œê¸€ ë³´ê¸°</a>
    <a href="write-post.html">ê²Œì‹œë¬¼ ì‘ì„±</a>
  </div>

  <div class="main">
    <div class="square">
      <h2 style="margin-top:0">ë‚´ ê²Œì‹œê¸€</h2>
      <div class="post-list" id="list"></div>
    </div>
  </div>

<script type="module">
  import { initializeApp, getApps } from "https://www.gstatic.com/firebasejs/11.9.1/firebase-app.js";
  import { getAuth, signInAnonymously } from "https://www.gstatic.com/firebasejs/11.9.1/firebase-auth.js";
  import {
    getFirestore, collection, query, where, orderBy, getDocs, doc, deleteDoc, limit,
    getDoc, setDoc, increment
  } from "https://www.gstatic.com/firebasejs/11.9.1/firebase-firestore.js";

  const firebaseConfig = {
    apiKey: "AIzaSyCrxJuOjHGdttC2gfwfjqsvAjHicEav6BA",
    authDomain: "wjgh-learningdataroom.firebaseapp.com",
    projectId: "wjgh-learningdataroom",
    storageBucket: "wjgh-learningdataroom.firebasestorage.app",
    messagingSenderId: "284248567704",
    appId: "1:284248567704:web:88e70e08666e13ff80c5ed"
  };
  const app = getApps().length ? getApps()[0] : initializeApp(firebaseConfig);
  const auth = getAuth(app);
  signInAnonymously(auth).catch(console.warn);
  const db = getFirestore(app);

  const API_BASE = "http://127.0.0.1:5000";

  // ë¡œê·¸ì¸ UI
  document.addEventListener("DOMContentLoaded", () => {
    const userStr = localStorage.getItem("user");
    const loginDiv = document.querySelector(".login");
    if (userStr) {
      const u = JSON.parse(userStr);
      loginDiv.textContent = `${u.name}ë‹˜ í™˜ì˜í•©ë‹ˆë‹¤`;
      loginDiv.style.fontWeight = "bold"; loginDiv.style.cursor = "default";
      loginDiv.addEventListener("click", () => {
        if (confirm("ë¡œê·¸ì•„ì›ƒ í•˜ì‹œê² ìŠµë‹ˆê¹Œ?")) { localStorage.removeItem("user"); location.reload(); }
      });
    } else {
      loginDiv.textContent = "ë¡œê·¸ì¸"; loginDiv.style.cursor = "pointer";
      loginDiv.addEventListener("click", () => location.href = "login.html");
    }
  });

  async function removeAttachmentIfAny(attachment){
    if (!attachment || !attachment.key) return;
    try {
      await fetch(`${API_BASE}/api/delete?key=${encodeURIComponent(attachment.key)}`, { method:"DELETE" });
    } catch(e){ console.warn("ì²¨ë¶€ ì‚­ì œ ì‹¤íŒ¨(ë¬´ì‹œ ê°€ëŠ¥):", e); }
  }

  /* ğŸ”» ì‚­ì œ ì‹œ ì ìˆ˜ ì°¨ê° */
  async function adjustScoreForDeletedPost(postData) {
    if (!postData) return;
    const sub = postData.subcategory || "ë¯¸ë¶„ë¥˜";
    let delta = 0;
    if (sub === "ì •ë³´ ê³µìœ ") delta = -2;
    else if (sub === "í•™ìŠµ ë„ì›€") delta = -1;
    else delta = 0;
    if (delta === 0) return;

    let userRef = null;
    if (postData.writerId) {
      userRef = doc(db, "users", String(postData.writerId));
    } else {
      if (!userRef && postData.writer) {
        const qs = await getDocs(query(collection(db, "users"), where("name","==", postData.writer), limit(1)));
        if (!qs.empty) userRef = doc(db, "users", qs.docs[0].id);
      }
      if (!userRef && postData.nickname) {
        const qs = await getDocs(query(collection(db, "users"), where("nickname","==", postData.nickname), limit(1)));
        if (!qs.empty) userRef = doc(db, "users", qs.docs[0].id);
      }
    }
    if (!userRef) return;
    await setDoc(userRef, { score: increment(delta) }, { merge: true });
  }

  async function loadMyPosts(){
    const user = JSON.parse(localStorage.getItem("user"));
    if (!user) { alert("ë¡œê·¸ì¸ í›„ ì´ìš©í•˜ì„¸ìš”."); location.href="login.html"; return; }

    const candidates = Array.from(new Set([user.name, user.id, user.nickname].filter(Boolean)));

    let docs = [];
    try {
      const q1 = query(collection(db, "posts"), where("writer", "in", candidates));
      const s1 = await getDocs(q1);
      s1.forEach(d => docs.push({ id: d.id, data: d.data() }));
    } catch (e) {
      // í›„ë³´ë³„ ê°œë³„ ì¡°íšŒ
      for (const w of candidates) {
        const q2 = query(collection(db, "posts"), where("writer", "==", w));
        const s2 = await getDocs(q2);
        s2.forEach(d => docs.push({ id: d.id, data: d.data() }));
      }
    }

    if (docs.length === 0) {
      try {
        const q3 = query(collection(db, "posts"), orderBy("createdAt", "desc"), limit(300));
        const s3 = await getDocs(q3);
        s3.forEach(d => {
          const data = d.data();
          if (candidates.includes(data.writer) || candidates.includes(data.nickname)) {
            docs.push({ id: d.id, data });
          }
        });
      } catch (e) {
        const s4 = await getDocs(collection(db, "posts"));
        s4.forEach(d => {
          const data = d.data();
          if (candidates.includes(data.writer) || candidates.includes(data.nickname)) {
            docs.push({ id: d.id, data });
          }
        });
      }
    }

    // ì¤‘ë³µ ì œê±° & ì •ë ¬
    const uniq = new Map();
    for (const it of docs) uniq.set(it.id, it);
    docs = Array.from(uniq.values());
    docs.sort((a, b) => {
      const ta = a.data.createdAt?.seconds ?? a.data.createdAt?._seconds ?? 0;
      const tb = b.data.createdAt?.seconds ?? b.data.createdAt?._seconds ?? 0;
      return tb - ta;
    });

    const list = document.getElementById("list");
    list.innerHTML = "";
    if (!docs.length) {
      list.innerHTML = "<div style='color:#777'>ì‘ì„±í•œ ê²Œì‹œê¸€ì´ ì—†ìŠµë‹ˆë‹¤.</div>";
      return;
    }

    for (const { id, data } of docs) {
      const div = document.createElement("div");
      div.className = "item";
      div.innerHTML = `
        <div>
          <div class="title">${data.title || "ì œëª© ì—†ìŒ"}</div>
          <div class="meta">${data.grade || ""} ï½œ ${data.nickname || "ìµëª…"} ï½œ ${data.subcategory || "ë¯¸ë¶„ë¥˜"}</div>
        </div>
        <div class="actions">
          <a class="btn btn-view" href="view-post.html?id=${id}">ë³´ê¸°</a>
          <button class="btn btn-del">ì‚­ì œ</button>
        </div>
      `;
      div.querySelector(".btn-del").addEventListener("click", async () => {
        if (!confirm("ì •ë§ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ? ì²¨ë¶€íŒŒì¼ë„ í•¨ê»˜ ì‚­ì œë©ë‹ˆë‹¤.")) return;
        try {
          // ì‚­ì œ ì „ ë¬¸ì„œ ë¡œë”© (ì ìˆ˜ ì°¨ê°/ì²¨ë¶€ í™•ì¸ìš©)
          const snap = await getDoc(doc(db, "posts", id));
          const full = snap.exists() ? snap.data() : data;

          await adjustScoreForDeletedPost(full);
          await removeAttachmentIfAny(full?.attachment);
          await deleteDoc(doc(db, "posts", id));

          div.remove();
          alert("ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.");
        } catch (e) {
          console.error(e);
          alert("ì‚­ì œ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.");
        }
      });
      list.appendChild(div);
    }
  }

  loadMyPosts();
</script>
</body>
</html>
