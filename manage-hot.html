<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=1024" />
  <title>ì—´í˜ˆë©¤ë²„ ê´€ë¦¬ - ì›ì£¼ì—¬ìê³ ë“±í•™êµ</title>
  <style>
    body{margin:0;font-family:'Noto Sans KR',sans-serif;background:#fff0f3;}
    .header{display:flex;justify-content:space-between;align-items:center;padding:10px 20px;border-bottom:2px solid #000;}
    .nav-container{flex:1;display:flex;justify-content:center;}
    .nav{display:flex;gap:80px;font-size:14px;}
    .nav a{text-decoration:none;color:#000;}
    .nav a:hover{font-weight:bold;}
    .login{background:#fce4ec;padding:5px 15px;border-radius:10px;font-size:14px;cursor:pointer;}

    .main{padding:30px;}
    .square{
      background:#FFDDE3;
      padding:30px;
      border-radius:10px;
      box-shadow:0 2px 5px rgba(0,0,0,.05);
      border:2px solid #f9aebe;
      margin-top:20px;
      max-width:1000px;
      margin-left:auto;margin-right:auto;
    }
    h2{margin:0 0 12px 0;color:#5b3b3b;font-size:22px;}

    .toolbar{display:flex;gap:10px;align-items:center;margin-bottom:12px;flex-wrap:wrap}
    .input{padding:8px;border:1px solid #f3b3c1;border-radius:8px;background:#fff;}
    .btn{
      background:#ffd2db;border:1px solid #f9aebe;color:#5b3b3b;
      padding:8px 12px;border-radius:8px;cursor:pointer;text-decoration:none;
    }
    .btn:hover{background:#fff3f5}

    table{width:100%;border-collapse:separate;border-spacing:0 8px;}
    thead th{font-size:13px;color:#666;text-align:left;padding:6px 10px;}
    tbody tr{
      background:#fff;border:1px solid #f9aebe;border-radius:10px;
      box-shadow:0 2px 5px rgba(0,0,0,.05);
    }
    tbody td{padding:10px;}
    .pill{
      display:inline-block;padding:4px 8px;border-radius:999px;font-size:12px;border:1px solid #f9aebe;background:#fff8fb;color:#5b3b3b;
    }
    .hot-badge{
      display:inline-block;margin-left:6px;padding:2px 6px;border-radius:6px;
      background:#ffe680;border:1px solid #f3c35f;color:#7a5200;font-size:11px;font-weight:700;
    }
    .toggle{
      appearance:none;width:42px;height:24px;border-radius:999px;position:relative;outline:none;cursor:pointer;border:1px solid #f9aebe;background:#ffeaef;vertical-align:middle;
    }
    .toggle:before{
      content:"";position:absolute;top:2px;left:2px;width:18px;height:18px;border-radius:50%;background:#fff;transition:all .2s;
      box-shadow:0 1px 2px rgba(0,0,0,.15);
    }
    .toggle:checked{background:#f9aebe;}
    .toggle:checked:before{left:22px;}
    .right{display:flex;gap:8px;align-items:center;justify-content:flex-end}
    .muted{font-size:12px;color:#888}
  </style>
</head>
<body>
  <div class="header">
    <a href="index.html" style="text-decoration:none;color:#000;padding:10px 20px;"><b>ì›ì£¼ì—¬ìê³ ë“±í•™êµ</b></a>
    <div class="nav-container">
      <div class="nav">
        <a href="posts.html">ê²Œì‹œíŒ</a>
        <a href="notice.html">ê³µì§€ì‚¬í•­</a>
        <a href="inquiry.html">ë¬¸ì˜í•˜ê¸°</a>
      </div>
    </div>
    <div class="login">ë¡œê·¸ì¸</div>
  </div>

  <div class="main">
    <div class="square">
      <h2>ì—´í˜ˆë©¤ë²„ ê´€ë¦¬</h2>
      <div class="muted" id="adminGuard" style="margin-bottom:8px;"></div>

      <div class="toolbar">
        <input id="kw" class="input" type="text" placeholder="ì´ë¦„/ë‹‰ë„¤ì„/í•™ë…„ ê²€ìƒ‰" />
        <button id="btnReload" class="btn">ìƒˆë¡œê³ ì¹¨</button>
      </div>

      <div class="muted" style="margin-bottom:6px;">â€» ğŸ”’ ê´€ë¦¬ìë§Œ ì ‘ê·¼ ê°€ëŠ¥í•©ë‹ˆë‹¤. Firestore ë³´ì•ˆ ê·œì¹™ì—ì„œ adminë§Œ users ì“°ê¸°ê°€ ê°€ëŠ¥í•˜ë„ë¡ ì„¤ì •í•´ ì£¼ì„¸ìš”.</div>

      <div style="overflow-x:auto;">
        <table>
          <thead>
            <tr>
              <th style="width:56px;">#</th>
              <th>ë‹‰ë„¤ì„</th>
              <th>ì´ë¦„</th>
              <th>í•™ë…„</th>
              <th>ì ìˆ˜</th>
              <th>ì—´í˜ˆ</th>
              <th style="width:160px;text-align:right;">ì‘ì—…</th>
            </tr>
          </thead>
          <tbody id="tbody">
            <tr><td colspan="7" class="muted" style="padding:14px;">ë¡œë”©ì¤‘â€¦</td></tr>
          </tbody>
        </table>
      </div>
    </div>
  </div>

  <script type="module">
    import { initializeApp, getApps } from "https://www.gstatic.com/firebasejs/11.9.1/firebase-app.js";
    import { getAuth, signInAnonymously } from "https://www.gstatic.com/firebasejs/11.9.1/firebase-auth.js";
    import { getFirestore, collection, getDocs, query, orderBy, updateDoc, doc } from "https://www.gstatic.com/firebasejs/11.9.1/firebase-firestore.js";

    // === Firebase config (ë„¤ í”„ë¡œì íŠ¸ ê°’ ê·¸ëŒ€ë¡œ) ===
    const firebaseConfig = {
      apiKey: "AIzaSyCrxJuOjHGdttC2gfwfjqsvAjHicEav6BA",
      authDomain: "wjgh-learningdataroom.firebaseapp.com",
      projectId: "wjgh-learningdataroom",
      storageBucket: "wjgh-learningdataroom.firebasestorage.app",
      messagingSenderId: "284248567704",
      appId: "1:284248567704:web:88e70e08666e13ff80c5ed"
    };

    // === App / Auth ===
    const app = getApps().length ? getApps()[0] : initializeApp(firebaseConfig);
    const auth = getAuth(app);
    signInAnonymously(auth).catch(()=>{});
    const db = getFirestore(app);

    // === Admin Guard (í”„ë¡ íŠ¸ ì²´í¬) ===
    const loginDiv = document.querySelector(".login");
    const guard = document.getElementById("adminGuard");
    const me = JSON.parse(localStorage.getItem("user") || "null");

    if (me) {
      loginDiv.textContent = `${me.name}ë‹˜ í™˜ì˜í•©ë‹ˆë‹¤`;
      loginDiv.style.fontWeight = "bold";
      loginDiv.style.cursor = "default";
      loginDiv.addEventListener("click", () => {
        if (confirm("ë¡œê·¸ì•„ì›ƒ í•˜ì‹œê² ìŠµë‹ˆê¹Œ?")) {
          localStorage.removeItem("user");
          location.href = "login.html";
        }
      });
    } else {
      loginDiv.textContent = "ë¡œê·¸ì¸";
      loginDiv.style.cursor = "pointer";
      loginDiv.addEventListener("click", () => location.href = "login.html");
    }

    if (!me || me.role !== "admin") {
      guard.textContent = "ì ‘ê·¼ ê¶Œí•œì´ ì—†ìŠµë‹ˆë‹¤. (ê´€ë¦¬ì ì „ìš©)";
      alert("ê´€ë¦¬ìë§Œ ì ‘ê·¼í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.");
      location.href = "index.html";
    }

    // === UI refs ===
    const kwInput = document.getElementById("kw");
    const btnReload = document.getElementById("btnReload");
    const tbody = document.getElementById("tbody");

    let rows = [];

    function scoreEmoji(score){
      if (score >= 20) return "ğŸ”¥";
      if (score >= 10) return "ğŸŒŸ";
      if (score >= 5)  return "ğŸ‘";
      return "";
    }

    function draw(list){
      tbody.innerHTML = "";
      if (!list.length){
        tbody.innerHTML = `<tr><td colspan="7" class="muted" style="padding:14px;">ì‚¬ìš©ì ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.</td></tr>`;
        return;
      }
      list.forEach((u, idx) => {
        const tr = document.createElement("tr");
        const badge = u.hotMember ? `<span class="hot-badge">HOT</span>` : "";
        tr.innerHTML = `
          <td>${idx+1}</td>
          <td>${(u.nickname||"")}${badge}</td>
          <td>${u.name||""}</td>
          <td><span class="pill">${u.grade||""}</span></td>
          <td>${u.score ?? 0} ${scoreEmoji(u.score||0)}</td>
          <td>
            <input type="checkbox" class="toggle" ${u.hotMember ? "checked" : ""} data-id="${u.__id}" />
          </td>
          <td>
            <div class="right">
              <button class="btn btn-save" data-id="${u.__id}">ì €ì¥</button>
              <span class="muted">ë¬¸ì„œID: ${u.__id}</span>
            </div>
          </td>
        `;
        tbody.appendChild(tr);
      });
    }

    function filterAndDraw(){
      const kw = (kwInput.value||"").trim().toLowerCase();
      const f = rows.filter(u => {
        const t = `${u.nickname||""} ${u.name||""} ${u.grade||""}`.toLowerCase();
        return !kw || t.includes(kw);
      });
      draw(f);
    }

    async function load(){
      tbody.innerHTML = `<tr><td colspan="7" class="muted" style="padding:14px;">ë¡œë”©ì¤‘â€¦</td></tr>`;
      rows = [];
      try {
        // ì ìˆ˜ìˆœìœ¼ë¡œ ì •ë ¬í•´ì„œ ë³´ì´ë©´ í¸í•¨
        const qy = query(collection(db,"users"), orderBy("score","desc"));
        const snap = await getDocs(qy);
        snap.forEach(d => rows.push({ __id: d.id, ...d.data() }));
      } catch (e){
        console.warn("ì •ë ¬ ì¿¼ë¦¬ ì‹¤íŒ¨ â†’ ì „ì²´ ìŠ¤ìº”:", e);
        const snap = await getDocs(collection(db,"users"));
        snap.forEach(d => rows.push({ __id: d.id, ...d.data() }));
        // score ê¸°ì¤€ ìˆ˜ë™ ì •ë ¬
        rows.sort((a,b)=>(b.score||0)-(a.score||0));
      }
      filterAndDraw();
    }

    // ì €ì¥(í† ê¸€ ë°˜ì˜)
    tbody.addEventListener("click", async (e) => {
      if (e.target.classList.contains("btn-save")){
        const id = e.target.getAttribute("data-id");
        const toggle = tbody.querySelector(`.toggle[data-id="${id}"]`);
        const makeHot = !!toggle?.checked;

        try {
          await updateDoc(doc(db,"users",id), { hotMember: makeHot });
          alert("ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤.");
          // ë©”ëª¨ë¦¬ ìƒíƒœ ì—…ë°ì´íŠ¸ í›„ ë‹¤ì‹œ ê·¸ë¦¬ê¸°
          const t = rows.find(x => x.__id === id);
          if (t) t.hotMember = makeHot;
          filterAndDraw();
        } catch (err){
          console.error(err);
          alert("ì €ì¥ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤. (ë³´ì•ˆ ê·œì¹™ì„ í™•ì¸í•˜ì„¸ìš”)");
        }
      }
    });

    kwInput.addEventListener("input", filterAndDraw);
    btnReload.addEventListener("click", load);

    load();
  </script>
</body>
</html>
